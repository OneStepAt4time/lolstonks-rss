#!/bin/sh
# Pre-push hook for LoL Stonks RSS
# Runs full test suite before allowing push
# Skips full test suite for documentation-only changes

set -e

echo "Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_error() {
    echo "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo "${GREEN}[SUCCESS]${NC} $1"
}

print_info() {
    echo "${YELLOW}[INFO]${NC} $1"
}

print_skip() {
    echo "${BLUE}[SKIP]${NC} $1"
}

# Get current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
print_info "Current branch: $CURRENT_BRANCH"

# Detect if this is a documentation-only change
print_info "Checking if changes are documentation-only..."
# Get list of changed files in recent commits
# For new branches, check last 5 commits; for existing, check pushed commits
CHANGED_FILES=$(git diff --name-only HEAD~5..HEAD 2>/dev/null || echo "")

# Check if any non-documentation files were changed
NON_DOC_FILES_CHANGED=false
DOC_PATTERN="^(README\.md|CHANGELOG\.md|CONTRIBUTING\.md|CLAUDE\.md|docs/.*|\.githooks/.*|\.github/.*|\.gitignore|\.dockerignore|pyproject\.toml|uv\.lock|\.python-version|requirements\.txt)$"

for file in $CHANGED_FILES; do
    if ! echo "$file" | grep -qE "$DOC_PATTERN"; then
        NON_DOC_FILES_CHANGED=true
        break
    fi
done

if [ "$NON_DOC_FILES_CHANGED" = false ] && [ -n "$CHANGED_FILES" ]; then
    print_skip "Documentation-only changes detected"
    print_skip "Skipping full test suite for documentation changes"
    DOCS_ONLY=true
else
    print_info "Source code changes detected - running full test suite"
    DOCS_ONLY=false
fi

# Prevent pushing directly to main/master
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    # Read stdin to check if pushing tags vs code
    while read local_ref local_sha remote_ref remote_sha; do
        case "$remote_ref" in
            refs/tags/*)
                print_info "Pushing tag: $remote_ref"
                print_success "Tag operations allowed on master"
                exit 0
                ;;
        esac
        case "$remote_ref" in
            refs/heads/main|refs/heads/master)
                print_error "Direct code push to $remote_ref is not allowed"
                print_info "Please create a pull request instead"
                print_info "If you need to push to $CURRENT_BRANCH, use: git push --no-verify"
                exit 1
                ;;
        esac
    done
fi

# Check UV is available
if ! command -v uv > /dev/null 2>&1; then
    print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
    exit 1
fi

# 1. Run all linting checks
print_info "Running Black formatting check..."
if ! uv run black --check --line-length 100 src/ tests/; then
    print_error "Black formatting check failed"
    print_info "Run: black --line-length 100 src/ tests/"
    exit 1
fi
print_success "Black formatting check passed"

print_info "Running Ruff linting..."
if ! uv run ruff check src/ tests/; then
    print_error "Ruff linting failed"
    print_info "Run: ruff check --fix src/ tests/"
    exit 1
fi
print_success "Ruff linting passed"

print_info "Running mypy type checking..."
if ! uv run mypy src/; then
    print_error "Mypy type checking failed"
    exit 1
fi
print_success "Mypy type checking passed"

# 2. Run test suite (skip for documentation-only changes)
if [ "$DOCS_ONLY" = true ]; then
    print_skip "Skipping test suite for documentation-only changes"
else
    # Note: E2E tests requiring running server (test_http_endpoints, test_rss_compliance, test_scheduler_api)
    # are run in CI/CD with server infrastructure. Pre-push runs unit/integration tests only.
    print_info "Running test suite (unit + integration + offline E2E)..."
    if ! uv run pytest -v --cov=src --cov-report=term --cov-report=html \
        --ignore=tests/e2e/test_http_endpoints.py \
        --ignore=tests/e2e/test_rss_compliance.py \
        --ignore=tests/e2e/test_scheduler_api.py \
        --ignore=tests/e2e/test_scheduler_e2e.py \
        --ignore=tests/e2e/test_scheduler_integration.py; then
        print_error "Tests failed"
        exit 1
    fi
    print_success "All tests passed"

    # 3. Check test coverage
    print_info "Checking test coverage..."
    COVERAGE=$(uv run pytest --cov=src --cov-report=term \
        --ignore=tests/e2e/test_http_endpoints.py \
        --ignore=tests/e2e/test_rss_compliance.py \
        --ignore=tests/e2e/test_scheduler_api.py \
        --ignore=tests/e2e/test_scheduler_e2e.py \
        --ignore=tests/e2e/test_scheduler_integration.py | grep "TOTAL" | awk '{print $4}' | sed 's/%//')
    if [ -n "$COVERAGE" ]; then
        COVERAGE_INT=${COVERAGE%.*}
        if [ "$COVERAGE_INT" -lt 90 ]; then
            print_error "Test coverage is below 90% (current: ${COVERAGE}%)"
            print_info "Please add more tests to improve coverage"
            exit 1
        fi
        print_success "Test coverage is adequate (${COVERAGE}%)"
    fi
fi

# 3. Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    print_error "You have uncommitted changes"
    print_info "Please commit or stash your changes before pushing"
    exit 1
fi

# All checks passed
print_success "All pre-push checks passed!"
echo ""
print_info "Pushing to remote..."

exit 0
