name: Publish News to GitHub Pages

on:
  # Run every 15 minutes to avoid GitHub Pages rate limiting
  schedule:
    - cron: '*/15 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      article_limit:
        description: 'Number of articles to include'
        required: false
        default: '100'
        type: string
      triggered_by:
        description: 'Source that triggered this workflow'
        required: false
        default: 'manual'
        type: string
      reason:
        description: 'Reason for triggering workflow'
        required: false
        default: 'manual-trigger'
        type: string

  # Run on push to main/develop for testing
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - '.github/workflows/publish-news.yml'
      - 'scripts/generate_news_page.py'
      - 'scripts/generate_rss_feeds.py'
      - 'templates/news_page.html'
      - 'src/rss/generator.py'
      - 'src/models.py'

# Ensure only one workflow runs at a time to prevent conflicts
concurrency:
  group: publish-news
  cancel-in-progress: false

# Required permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  publish-news:
    name: Fetch News & Deploy to GitHub Pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      - name: Log trigger source
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Workflow triggered by: ${{ github.event.inputs.triggered_by || 'manual' }}"
          echo "Reason: ${{ github.event.inputs.reason || 'manual-trigger' }}"
          echo "Triggered at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies with UV
        run: |
          uv sync

      - name: Create data directory
        run: mkdir -p data

      - name: Initialize database (if needed)
        run: |
          uv run python -c "
          import asyncio
          from src.database import ArticleRepository
          from src.config import get_settings

          async def init_db():
              settings = get_settings()
              repo = ArticleRepository(settings.database_path)
              await repo.initialize()
              await repo.close()
              print('Database initialized')

          asyncio.run(init_db())
          "

      - name: Fetch latest news from Riot APIs (LoL + TFT + Wild Rift)
        id: fetch_news
        # Graceful degradation: continue even if some locales fail
        continue-on-error: true
        run: |
          uv run python -c "
          import asyncio
          import os
          import sys
          from src.database import ArticleRepository
          from src.services.update_service import UpdateServiceV2
          from src.config import get_settings

          # Validated working locales - tested against Riot Next.js API
          # These locales work for LoL, TFT, and Wild Rift domains
          WORKING_LOCALES = [
              'en-us',  # English - United States (primary)
              'en-gb',  # English - Great Britain
              'es-es',  # Spanish - Spain
              'es-mx',  # Spanish - Mexico
              'fr-fr',  # French - France
              'de-de',  # German - Germany
              'it-it',  # Italian - Italy
              'pt-br',  # Portuguese - Brazil
              'ja-jp',  # Japanese - Japan
              'ko-kr',  # Korean - Korea
              'ru-ru',  # Russian - Russia
              'tr-tr',  # Turkish - Turkey
              'pl-pl',  # Polish - Poland
              'zh-tw',  # Chinese - Traditional (Taiwan)
              'ar-ae',  # Arabic - UAE
              'vi-vn',  # Vietnamese - Vietnam
              'th-th',  # Thai - Thailand
              'id-id',  # Indonesian - Indonesia
              'cs-cz',  # Czech - Czech Republic
              'el-gr',  # Greek - Greece
              'en-au',  # English - Australia
              'en-sg',  # English - Singapore
              'hu-hu',  # Hungarian - Hungary
              # Excluded - Riot geo-redirects these (no standalone news pages):
              # 'zh-cn' - China uses Tencent (lol.qq.com), Riot redirects with 307
              # 'ph-ph' - Philippines has no localized content, Riot redirects with 307
          ]

          async def update_news():
              settings = get_settings()
              repo = ArticleRepository(settings.database_path)
              await repo.initialize()

              try:
                  # UpdateServiceV2 now fetches from LoL + TFT + Wild Rift domains
                  # with per-category sub-pages for each game
                  update_service = UpdateServiceV2(repo)
                  stats = await update_service.update_locales(WORKING_LOCALES)

                  print(f'Update complete: {stats[\"new_articles\"]} new articles')
                  print(f'Successful tasks: {stats[\"successful_tasks\"]}/{stats[\"total_tasks\"]}')
                  print(f'Failed tasks: {stats[\"failed_tasks\"]}')

                  # Set output for use in conditional steps
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f'new_articles={stats[\"new_articles\"]}\n')
                      f.write(f'successful_tasks={stats[\"successful_tasks\"]}\n')
                      f.write(f'failed_tasks={stats[\"failed_tasks\"]}\n')

                  # Exit with success even if some tasks failed (graceful degradation)
                  # Only fail if ALL tasks failed
                  if stats['total_tasks'] > 0 and stats['successful_tasks'] == 0:
                      print('WARNING: All update tasks failed!')
                      sys.exit(1)

              except Exception as e:
                  print(f'Error during news update: {e}')
                  # Set output to indicate failure but allow workflow to continue
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write('new_articles=0\n')
                      f.write('successful_tasks=0\n')
                      f.write('failed_tasks=1\n')
                  raise
              finally:
                  await repo.close()

          asyncio.run(update_news())
          "
        timeout-minutes: 10

      - name: Generate news HTML page
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        run: |
          ARTICLE_LIMIT="${{ github.event.inputs.article_limit || '100' }}"
          uv run python scripts/generate_news_page.py --output news.html --limit "$ARTICLE_LIMIT"
        timeout-minutes: 2

      - name: Generate RSS feeds (LoL + TFT + Wild Rift, per-category)
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        run: |
          ARTICLE_LIMIT="${{ github.event.inputs.article_limit || '100' }}"
          uv run python scripts/generate_rss_feeds.py --output _site --limit "$ARTICLE_LIMIT"
        timeout-minutes: 5

      - name: Create GitHub Pages directory structure
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        run: |
          # Copy HTML page
          cp news.html _site/index.html

          # Create a simple redirect page for news.html
          printf '%s\n' \
            '<!DOCTYPE html>' \
            '<html>' \
            '<head>' \
            '  <meta http-equiv="refresh" content="0; url=/lolstonksrss/">' \
            '  <script>window.location.href = "/lolstonksrss/";</script>' \
            '</head>' \
            '<body>' \
            '  Redirecting to <a href="/lolstonksrss/">/lolstonksrss/</a>...' \
            '</body>' \
            '</html>' > _site/news.html

          # Copy any static assets if they exist
          if [ -d "static" ]; then
            cp -r static _site/
          fi

          # Verify feed files were generated
          echo "Verifying generated files:"
          ls -la _site/
          echo "Feed subdirectory:"
          ls -la _site/feed/ || echo "No feed subdirectory found"
          echo "LoL category feeds:"
          ls _site/feed/lol/ 2>/dev/null | head -5 || echo "No LoL category feeds"
          echo "TFT feeds:"
          ls _site/feed/tft/ 2>/dev/null | head -5 || echo "No TFT feeds"
          echo "Wild Rift feeds:"
          ls _site/feed/wildrift/ 2>/dev/null | head -5 || echo "No Wild Rift feeds"

      - name: Add .nojekyll file
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        run: touch _site/.nojekyll

      - name: Upload artifact for GitHub Pages
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        uses: actions/deploy-pages@v4
        # Retry on rate limiting (429) or internal errors (500)
        continue-on-error: false

      - name: Output deployment URL
        if: github.event_name == 'workflow_dispatch' || steps.fetch_news.outputs.new_articles != '0'
        run: |
          echo "News page deployed to: ${{ steps.deployment.outputs.page_url }}"
          echo "Direct link: ${{ steps.deployment.outputs.page_url }}index.html"
          echo ""
          echo "RSS Feeds:"
          echo "  Main feed (all articles): ${{ steps.deployment.outputs.page_url }}feed.xml"
          echo "  LoL English: ${{ steps.deployment.outputs.page_url }}feed/en-us.xml"
          echo "  LoL Italian: ${{ steps.deployment.outputs.page_url }}feed/it-it.xml"
          echo "  LoL Game Updates: ${{ steps.deployment.outputs.page_url }}feed/lol/en-us/game-updates.xml"
          echo "  TFT English: ${{ steps.deployment.outputs.page_url }}feed/tft/en-us.xml"
          echo "  Wild Rift English: ${{ steps.deployment.outputs.page_url }}feed/wildrift/en-us.xml"

      - name: Skip deployment notification
        if: github.event_name != 'workflow_dispatch' && steps.fetch_news.outputs.new_articles == '0'
        run: |
          echo "No new articles found. Skipping deployment to avoid unnecessary GitHub Pages updates."
          echo "This helps prevent rate limiting and reduces load on GitHub infrastructure."

      - name: Verify RSS feed deployment
        run: |
          sleep 10
          echo "Verifying RSS feeds are accessible..."

          # Verify main feed
          if curl -sSf "${{ steps.deployment.outputs.page_url }}feed.xml" > /dev/null; then
            echo "✓ Main feed is accessible"
          else
            echo "✗ Main feed may not be accessible yet"
          fi

          # Verify English feed
          if curl -sSf "${{ steps.deployment.outputs.page_url }}feed/en-us.xml" > /dev/null; then
            echo "✓ English feed is accessible"
          else
            echo "✗ English feed may not be accessible yet"
          fi

          # Verify Italian feed
          if curl -sSf "${{ steps.deployment.outputs.page_url }}feed/it-it.xml" > /dev/null; then
            echo "✓ Italian feed is accessible"
          else
            echo "✗ Italian feed may not be accessible yet"
          fi

          echo "Deployment verification complete!"
        continue-on-error: true

      - name: Verify HTML page deployment
        run: |
          curl -sSf "${{ steps.deployment.outputs.page_url }}" > /dev/null && echo "HTML page deployment successful!" || echo "Warning: HTML page deployment may still be propagating"
        continue-on-error: true

      # Cache database for next run (optional - reduces API calls)
      - name: Cache database
        uses: actions/cache@v4
        with:
          path: data/articles.db
          key: lol-news-db-${{ github.run_number }}
          restore-keys: |
            lol-news-db-
