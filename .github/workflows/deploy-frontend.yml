name: Deploy Frontend to GitHub Pages

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm run build
          # Check build output
          ls -la dist/

      # RSS Feed Generation
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install Python dependencies with UV
        run: uv sync

      - name: Create data directory
        run: mkdir -p data

      - name: Initialize database
        run: |
          uv run python -c "
          import asyncio
          from src.database import ArticleRepository
          from src.config import get_settings

          async def init_db():
              settings = get_settings()
              repo = ArticleRepository(settings.database_path)
              await repo.initialize()
              await repo.close()
              print('Database initialized')

          asyncio.run(init_db())
          "

      - name: Fetch latest news from LoL API
        run: |
          uv run python -c "
          import asyncio
          import os
          from src.database import ArticleRepository
          from src.services.update_service import UpdateServiceV2
          from src.config import get_settings

          # Only fetch from the official Riot API (lol source)
          # HTML scrapers are too slow and unreliable for deployment
          WORKING_LOCALES = [
              'en-us', 'en-gb', 'es-es', 'es-mx', 'fr-fr', 'de-de',
              'it-it', 'pt-br', 'ja-jp', 'ko-kr',
          ]

          async def update_news():
              settings = get_settings()
              repo = ArticleRepository(settings.database_path)
              await repo.initialize()

              update_service = UpdateServiceV2(repo)
              # Only use 'lol' source (official Riot API) - it's fast and reliable
              stats = await update_service.update_source('lol', WORKING_LOCALES)

              print(f'Update complete: {stats[\"new_articles\"]} new articles')
              print(f'Total articles in DB: {stats.get(\"total_articles\", 0)}')

              await repo.close()

          asyncio.run(update_news())
          "
        timeout-minutes: 3

      - name: Generate RSS feeds to frontend dist
        run: |
          uv run python scripts/generate_rss_feeds.py --output ./frontend/dist --limit 100

      - name: Verify RSS feeds in dist
        run: |
          echo "Checking RSS feed files in frontend/dist:"
          ls -la ./frontend/dist/
          echo "Feed subdirectory:"
          ls -la ./frontend/dist/feed/ || echo "No feed subdirectory found"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./frontend/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
