# LoL Stonks RSS API

FastAPI web server exposing RSS feeds for League of Legends news.

## Endpoints

### GET /
Root endpoint with usage information and available endpoints.

**Response:** Plain text with API documentation

---

### GET /feed.xml
Main RSS feed with all articles from all sources.

**Query Parameters:**
- `limit` (int, optional): Maximum number of articles (default: 50, max: 200)

**Response:** RSS 2.0 XML feed

**Example:**
```bash
curl http://localhost:8000/feed.xml
curl http://localhost:8000/feed.xml?limit=10
```

---

### GET /feed/{source}.xml
Source-specific RSS feed.

**Path Parameters:**
- `source` (str): Source identifier
  - `en-us` - English (US)
  - `it-it` - Italian

**Query Parameters:**
- `limit` (int, optional): Maximum number of articles (default: 50, max: 200)

**Response:** RSS 2.0 XML feed

**Example:**
```bash
curl http://localhost:8000/feed/en-us.xml
curl http://localhost:8000/feed/it-it.xml?limit=25
```

---

### GET /feed/category/{category}.xml
Category-specific RSS feed.

**Path Parameters:**
- `category` (str): Category name (e.g., Champions, Patches, Media)

**Query Parameters:**
- `limit` (int, optional): Maximum number of articles (default: 50, max: 200)

**Response:** RSS 2.0 XML feed

**Example:**
```bash
curl http://localhost:8000/feed/category/Champions.xml
curl http://localhost:8000/feed/category/Patches.xml?limit=15
```

---

### GET /health
Health check endpoint.

**Response:** JSON with service status and statistics

**Example Response:**
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "service": "LoL Stonks RSS",
  "database": "connected",
  "cache": "active",
  "has_articles": true
}
```

---

### POST /admin/refresh
Invalidate feed cache (manual refresh).

**Response:** JSON with refresh status

**Example:**
```bash
curl -X POST http://localhost:8000/admin/refresh
```

**Example Response:**
```json
{
  "status": "success",
  "message": "Feed cache invalidated"
}
```

---

### GET /docs
OpenAPI documentation (Swagger UI).

Interactive API documentation automatically generated by FastAPI.

---

### GET /openapi.json
OpenAPI schema in JSON format.

---

## Running the Server

### Development Mode
```bash
# With auto-reload enabled
python main.py
```

### Production Mode
```bash
# Using uvicorn directly
uvicorn src.api.app:app --host 0.0.0.0 --port 8000

# Or with more workers for production
uvicorn src.api.app:app --host 0.0.0.0 --port 8000 --workers 4
```

### Docker
```bash
# Build image
docker build -t lolstonksrss .

# Run container
docker run -p 8000:8000 lolstonksrss
```

---

## Configuration

Environment variables (can also be set in `.env` file):

### Server Settings
- `BASE_URL` - Base URL for feed links (default: `http://localhost:8000`)
- `HOST` - Server host (default: `0.0.0.0`)
- `PORT` - Server port (default: `8000`)
- `RELOAD` - Enable auto-reload for development (default: `false`)
- `LOG_LEVEL` - Logging level (default: `INFO`)

### Feed Settings
- `FEED_CACHE_TTL` - Feed cache TTL in seconds (default: `300`)
- `RSS_MAX_ITEMS` - Maximum items per feed (default: `50`)
- `RSS_FEED_TITLE` - Default feed title
- `RSS_FEED_DESCRIPTION` - Default feed description
- `RSS_FEED_LINK` - Default feed link

### Database Settings
- `DATABASE_PATH` - SQLite database path (default: `data/articles.db`)

---

## Features

### CORS Support
The API includes CORS middleware configured to allow cross-origin requests:
- All origins allowed (configure for production)
- GET and POST methods supported
- All headers allowed

### Caching
Feed responses include `Cache-Control` headers:
```
Cache-Control: public, max-age=300
```

Default cache TTL is 5 minutes (300 seconds), configurable via `FEED_CACHE_TTL`.

### Content Type
All RSS feeds are served with proper content type:
```
Content-Type: application/rss+xml; charset=utf-8
```

### Error Handling
- **404** - Invalid source or category
- **500** - Server error during feed generation
- All errors return JSON with `detail` field

### RSS 2.0 Compliance
All feeds are generated according to RSS 2.0 specification:
- Valid XML structure
- Required channel elements
- Proper date formatting (RFC 822)
- GUID for each item
- Optional media enclosures for images

---

## Testing

```bash
# Run API tests
pytest tests/test_api.py -v

# Run with coverage
pytest tests/test_api.py -v --cov=src/api

# Run integration tests
pytest tests/integration/test_server_integration.py -v -m slow

# Run all tests
pytest -v
```

---

## API Client Examples

### Python
```python
import httpx

# Get main feed
response = httpx.get("http://localhost:8000/feed.xml")
print(response.text)

# Get source-specific feed
response = httpx.get("http://localhost:8000/feed/en-us.xml")
print(response.text)

# Health check
response = httpx.get("http://localhost:8000/health")
print(response.json())
```

### JavaScript
```javascript
// Get main feed
fetch('http://localhost:8000/feed.xml')
  .then(response => response.text())
  .then(xml => console.log(xml));

// Health check
fetch('http://localhost:8000/health')
  .then(response => response.json())
  .then(data => console.log(data));
```

### RSS Reader
Add feed URLs directly to your RSS reader:
- Main feed: `http://localhost:8000/feed.xml`
- English feed: `http://localhost:8000/feed/en-us.xml`
- Italian feed: `http://localhost:8000/feed/it-it.xml`

---

## Architecture

### Lifespan Management
The application uses FastAPI's lifespan context manager for:
- Database initialization on startup
- Service initialization
- Cleanup on shutdown

### Async Throughout
All endpoints and database operations use async/await for optimal performance.

### Dependency Injection
Services are stored in app state and accessed via helper functions.

---

## Performance

### Caching Strategy
- Feed results are cached in memory
- Cache TTL is configurable
- Manual cache invalidation via `/admin/refresh`

### Concurrent Requests
The server handles concurrent requests efficiently using async I/O.

### Optimizations
- Connection pooling for database
- Lazy feed generation
- Response compression (via uvicorn)

---

## Monitoring

### Health Checks
The `/health` endpoint provides:
- Service status
- Database connectivity
- Cache status
- Article availability

Use this endpoint for:
- Load balancer health checks
- Monitoring systems
- Uptime verification

---

## Security Considerations

### Production Deployment
1. Configure CORS for specific origins
2. Add rate limiting
3. Enable HTTPS
4. Set proper security headers
5. Use environment variables for sensitive config
6. Restrict `/admin/*` endpoints

### Example Production CORS
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://yourdomain.com"],
    allow_credentials=True,
    allow_methods=["GET"],
    allow_headers=["*"],
)
```

---

## Troubleshooting

### Server won't start
- Check if port 8000 is already in use
- Verify database path is writable
- Check Python version (3.11+ required)

### Empty feeds
- Run health check to verify database has articles
- Check database path configuration
- Verify articles are being fetched and saved

### Slow responses
- Check cache TTL settings
- Monitor database performance
- Increase uvicorn workers for production

---

## License

This project is part of the LoL Stonks RSS application.
